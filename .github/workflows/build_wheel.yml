name: Build Wheels Only

on:
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.13"
  VCPKG_LIBRARY_LINKAGE: dynamic

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      SKBUILD_CONFIG: Release
      VCPKG_TARGET_TRIPLET: x64-windows-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip" # Cache pip packages

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Upgrade pip & install deps
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install scikit-build-core pybind11 numpy ninja
          python -m pip install torch torchvision --index-url https://download.pytorch.org/whl/cu130

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ${{ runner.temp }}/vcpkg
            ${{ runner.temp }}/vcpkg/installed
            ${{ runner.temp }}/vcpkg/archives
          key: vcpkg-${{ runner.os }}-${{ env.VCPKG_TARGET_TRIPLET }}-dav1d-v2-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-${{ env.VCPKG_TARGET_TRIPLET }}-dav1d-v2-

      - name: Bootstrap vcpkg
        shell: powershell
        run: |
          if (-not (Test-Path "${{ runner.temp }}/vcpkg")) {
            git clone https://github.com/microsoft/vcpkg.git "${{ runner.temp }}/vcpkg"
          }
          & "${{ runner.temp }}/vcpkg/bootstrap-vcpkg.bat" -disableMetrics

      - name: Update vcpkg ports
        shell: cmd
        run: |
          cd "${{ runner.temp }}\vcpkg"
          git fetch origin master
          git reset --hard origin/master
          git clean -fd

      - name: Set VCPKG env vars
        shell: bash
        run: |
          echo "VCPKG_ROOT=${RUNNER_TEMP}/vcpkg"                          >> $GITHUB_ENV
          echo "VCPKG_TOOLCHAIN_FILE=${RUNNER_TEMP}/vcpkg/scripts/buildsystems/vcpkg.cmake" >> $GITHUB_ENV
          echo "VCPKG_TARGET_TRIPLET=x64-windows-release"                        >> $GITHUB_ENV
          echo "CMAKE_PREFIX_PATH=${RUNNER_TEMP}/vcpkg/installed/x64-windows-release"                       >> $GITHUB_ENV

      - name: Install C++ deps via vcpkg
        shell: cmd
        run: |
          "${{ runner.temp }}\vcpkg\vcpkg" install spdlog fmt libyuv --triplet x64-windows-release --recurse

      - name: Download FFmpeg for build (headers/libs only)
        shell: powershell
        run: |
          # FFmpeg is needed for headers/import libs at build time
          # The DLLs are NOT bundled - users must have FFmpeg in their PATH
          $FFmpegUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full-shared.7z"
          $OutputDir = "${{ github.workspace }}/external/ffmpeg"
          $TempDir = "${{ runner.temp }}/ffmpeg_download"

          New-Item -ItemType Directory -Path $TempDir -Force | Out-Null
          New-Item -ItemType Directory -Path $OutputDir -Force | Out-Null

          Write-Host "Downloading FFmpeg (for build-time headers/libs only)..."
          Start-BitsTransfer -Source $FFmpegUrl -Destination "$TempDir/ffmpeg.7z"

          Write-Host "Extracting FFmpeg..."
          7z x "$TempDir/ffmpeg.7z" -o"$TempDir/extracted" -y

          $FFmpegDir = Get-ChildItem -Path "$TempDir/extracted" -Directory | Select-Object -First 1
          # Copy all directories including bin (needed for running tests, but NOT bundled by CMake)
          Copy-Item -Path "$($FFmpegDir.FullName)/bin" -Destination $OutputDir -Recurse -Force
          Copy-Item -Path "$($FFmpegDir.FullName)/lib" -Destination $OutputDir -Recurse -Force
          Copy-Item -Path "$($FFmpegDir.FullName)/include" -Destination $OutputDir -Recurse -Force

          Write-Host "=== FFmpeg installed (headers/libs for build, bin for testing) ==="

      - name: Setup CUDA toolkit
        uses: Jimver/cuda-toolkit@v0.2.30
        id: cuda-toolkit
        with:
          cuda: "13.1.0"
          method: "local"
          use-github-cache: true
          use-local-cache: true
          sub-packages: '["nvcc", "cudart", "visual_studio_integration", "thrust", "nvrtc", "nvrtc_dev"]'

      - name: Verify CUDA installation
        shell: bash
        run: |
          echo "CUDA_PATH: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}"
          ls -la "${{ steps.cuda-toolkit.outputs.CUDA_PATH }}/bin/" | head -20
          "${{ steps.cuda-toolkit.outputs.CUDA_PATH }}/bin/nvcc.exe" --version

          echo "Checking for crt/host_config.h..."
          if [ -f "${{ steps.cuda-toolkit.outputs.CUDA_PATH }}/include/crt/host_config.h" ]; then
            echo "SUCCESS: host_config.h found."
          else
            echo "FATAL: host_config.h NOT found!"
            echo "CUDA installation is incomplete. Cannot build CUDA wheel."
            find "${{ steps.cuda-toolkit.outputs.CUDA_PATH }}" -name "host_config.h" || true
            exit 1
          fi

      - name: Build Windows wheel
        shell: bash
        env:
          CMAKE_GENERATOR: Ninja
          SKBUILD_CONFIG: Release
          CELUX_ENABLE_CUDA: "ON"
        run: |
          # Convert backslashes to forward slashes to avoid CMake escaping issues on Windows
          TEMP_FWD=$(echo "$RUNNER_TEMP" | tr '\\' '/')

          # Sanitize CUDA_PATH path as well
          CUDA_PATH_FWD=$(echo "$CUDA_PATH" | tr '\\' '/')
          export CUDA_PATH="$CUDA_PATH_FWD"

          export VCPKG_ROOT="${TEMP_FWD}/vcpkg"
          export VCPKG_TOOLCHAIN_FILE="${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake"
          export VCPKG_TARGET_TRIPLET=x64-windows-release
          export CMAKE_PREFIX_PATH="${VCPKG_ROOT}/installed/x64-windows-release"

          # Construct CMAKE_ARGS with sanitized paths AND FORCE CELUX_ENABLE_CUDA=ON
          export CMAKE_ARGS="-DCMAKE_TOOLCHAIN_FILE=${VCPKG_TOOLCHAIN_FILE} -DVCPKG_TARGET_TRIPLET=${VCPKG_TARGET_TRIPLET} -DCMAKE_PREFIX_PATH=${CMAKE_PREFIX_PATH} -DCELUX_ENABLE_CUDA=ON"

          echo "CMAKE_ARGS: $CMAKE_ARGS"
          # Use --no-build-isolation so we usage the pre-installed CUDA-enabled Torch
          python -m pip wheel . --no-deps --no-build-isolation -w dist -v

      - name: Repair wheel with delvewheel (bundle DLLs)
        shell: powershell
        run: |
          Write-Host "=== Installing delvewheel ==="
          pip install delvewheel

          Write-Host "=== Setting up DLL search paths ==="
          # Add all DLL directories to PATH for delvewheel to find dependencies
          $VcpkgBin = Join-Path $env:RUNNER_TEMP "vcpkg\installed\x64-windows-release\bin"
          $CudaBin = Join-Path $env:CUDA_PATH "bin"

          Write-Host "VCPKG bin: $VcpkgBin"
          Write-Host "CUDA bin: $CudaBin"

          # Find the wheel file
          $WheelFile = Get-ChildItem dist/*.whl | Select-Object -First 1
          Write-Host "Repairing wheel: $($WheelFile.FullName)"

          # Create repaired output directory
          New-Item -ItemType Directory -Path dist_repaired -Force | Out-Null

          # Run delvewheel repair with additional paths
          # --add-path adds directories to search for DLLs
          # --no-mangle prevents renaming DLLs (optional, depends on your needs)
          delvewheel repair $WheelFile.FullName `
            --add-path "$VcpkgBin" `
            --add-path "$CudaBin" `
            --wheel-dir dist_repaired `
            -v

          # Replace original wheel with repaired one
          Remove-Item dist/*.whl -Force
          Move-Item dist_repaired/*.whl dist/
          Remove-Item dist_repaired -Recurse -Force

          Write-Host "=== Wheel repair complete ==="

      - name: List wheel contents
        run: |
          echo "=== Wheel contents (CUDA DLLs bundled via delvewheel, FFmpeg NOT bundled) ==="
          unzip -l dist/*.whl | grep celux/

      - name: Test wheel import
        shell: powershell
        run: |
          Write-Host "=== Installing wheel and testing import ==="
          pip install (Get-ChildItem dist/*.whl) --force-reinstall

          # Add FFmpeg bin to PATH for the test (Native Windows Path)
          $FFmpegBin = Join-Path $pwd "external\ffmpeg\bin"
          Write-Host "Adding to PATH: $FFmpegBin"
          $env:PATH = "$FFmpegBin;$env:PATH"

          # Python script to debug DLL loading
          $Script = @'
          import os
          import sys
          import ctypes
          import glob

          print(f"Python: {sys.version}")
          cwd = os.getcwd()
          print(f"CWD: {cwd}")

          ffmpeg_bin = os.path.join(cwd, "external", "ffmpeg", "bin")

          if os.path.exists(ffmpeg_bin):
              print(f"Found FFmpeg bin at: {ffmpeg_bin}")
              dll_files = [f for f in os.listdir(ffmpeg_bin) if f.endswith('.dll')]
              print(f"DLLs in bin: {dll_files}")
              
              if hasattr(os, "add_dll_directory"):
                  print(f"Calling os.add_dll_directory('{ffmpeg_bin}')")
                  try:
                      os.add_dll_directory(ffmpeg_bin)
                      print("  [OK] Added DLL directory.")
                  except Exception as e:
                      print(f"  [ERROR] Failed to add DLL directory: {e}")
          else:
              print(f"[ERROR] FFmpeg bin directory not found at: {ffmpeg_bin}")
              ext_dir = os.path.join(cwd, "external", "ffmpeg")
              if os.path.exists(ext_dir):
                  print(f"Contents of {ext_dir}: {os.listdir(ext_dir)}")
              else:
                  print(f"{ext_dir} does not exist!")

          print("--- Importing CeLux ---")
          try:
              import celux
              print(f"SUCCESS! celux: {celux.__version__}")
              
              if hasattr(celux, "__cuda_support__"):
                  print(f"CUDA Support: {celux.__cuda_support__}")
                  if not celux.__cuda_support__:
                      print("FATAL: Wheel was built without CUDA support!")
                      sys.exit(1)
              else:
                  print("CUDA Support: [UNKNOWN] (__cuda_support__ not found)")
                  sys.exit(1)
          except ImportError as e:
              print(f"FATAL: Import failed: {e}")
              print("--- Diagnostic: Trying to load DLLs manually ---")
              if os.path.exists(ffmpeg_bin):
                  for dll in glob.glob(os.path.join(ffmpeg_bin, "avcodec*.dll")):
                      try:
                          print(f"Attempting to load {os.path.basename(dll)}...")
                          ctypes.CDLL(dll)
                          print("  [OK] Load successful")
                      except OSError as dll_err:
                          print(f"  [FAIL] Failed to load: {dll_err}")
              sys.exit(1)
          '@

          $Script | Set-Content -Path "debug_import.py" -Encoding UTF8
          python debug_import.py
          write-host "=== Import test passed ==="

      - name: Upload Windows wheel
        uses: actions/upload-artifact@v4
        with:
          name: windows-wheel
          path: "dist/*.whl"
#  build-linux:
#    runs-on: ubuntu-latest
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Setup Python 3.13
#        uses: actions/setup-python@v4
#        with:
#          python-version: "3.13"
#
#      - name: Install cibuildwheel
#        run: python -m pip install cibuildwheel==2.20.0
#
#      - name: Cache vcpkg
#        uses: actions/cache@v4
#        with:
#          path: /tmp/vcpkg_cache
#          key: vcpkg-linux-${{ hashFiles('pyproject.toml') }}
#          restore-keys: |
#            vcpkg-linux-
#
#      - name: Build Linux wheel
#        env:
#          CIBW_BUILD: "cp313-manylinux*_x86_64"
#          CIBW_ARCHS_LINUX: "x86_64"
#          CIBW_MANYLINUX_X86_64_IMAGE: "manylinux_2_28"
#          CIBW_CONTAINER_OPTIONS: "-v /tmp/vcpkg_cache:/opt/vcpkg"
#          CIBW_ENVIRONMENT_LINUX: >-
#            SKBUILD_CONFIG=Release
#            SKBUILD_GENERATOR=Ninja
#            VCPKG_TARGET_TRIPLET=x64-linux-dynamic
#            VCPKG_TOOLCHAIN_FILE=/opt/vcpkg/scripts/buildsystems/vcpkg.cmake
#            VCPKG_FORCE_SYSTEM_BINARIES=1
#            CC=gcc
#            CXX=g++
#            LD_LIBRARY_PATH=/opt/vcpkg/installed/x64-linux-dynamic/lib:$LD_LIBRARY_PATH
#            CMAKE_ARGS="-DCMAKE_TOOLCHAIN_FILE=/opt/vcpkg/scripts/buildsystems/vcpkg.cmake
#                        -DVCPKG_TARGET_TRIPLET=x64-linux-dynamic
#                        -DCMAKE_PREFIX_PATH=/opt/vcpkg/installed/x64-linux-dynamic
#                        -DCMAKE_MODULE_PATH=/opt/vcpkg/installed/x64-linux-dynamic/share/ffmpeg"
#          CIBW_REPAIR_WHEEL_COMMAND_LINUX: "export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/vcpkg/installed/x64-linux-dynamic/lib; auditwheel repair -w {dest_dir} {wheel} --exclude libtorch_python.so --exclude libtorch_cpu.so --exclude libc10.so --exclude libtorch.so"
#          CIBW_BEFORE_ALL_LINUX: |
#            (command -v dnf >/dev/null 2>&1 && dnf -y install \
#               git pkgconf nasm zip unzip curl tar \
#               gcc gcc-c++ make ninja-build cmake || \
#             command -v yum >/dev/null 2>&1 && yum -y install \
#               git pkgconf nasm zip unzip curl tar \
#               gcc gcc-c++ make ninja-build cmake)
#            # Only clone if not already present (from cache)
#            if [ ! -d "/opt/vcpkg/.git" ]; then
#                git clone https://github.com/microsoft/vcpkg /opt/vcpkg
#            fi
#            /opt/vcpkg/bootstrap-vcpkg.sh -disableMetrics
#            /opt/vcpkg/vcpkg install spdlog fmt libyuv ffmpeg[avcodec,avdevice,avfilter,avformat,core,dav1d,swresample,swscale,x264,x265] --triplet x64-linux-dynamic --recurse
#          CIBW_BEFORE_BUILD_LINUX: |
#            python -m pip install -U pip wheel setuptools
#            python -m pip install --only-binary=:all: "pybind11>=2.11"
#            python -m pip install --only-binary=:all: torch || python -m pip install --only-binary=:all: --index-url https://download.pytorch.org/whl/cpu torch
#          CIBW_OUTPUT_DIR: dist
#        run: python -m cibuildwheel --platform linux
#
#      - name: Verify dav1d in wheel
#        run: |
#          echo "=== Checking for dav1d in wheel ==="
#          unzip -l dist/*.whl | grep -i dav1d || (echo "ERROR: dav1d not bundled in wheel!" && exit 1)
#          echo "=== dav1d verification passed ==="
#
#      - name: Test wheel import
#        run: |
#          echo "=== Installing wheel and testing import ==="
#          python -m pip install dist/*.whl --force-reinstall
#          python -m pip install torch --index-url https://download.pytorch.org/whl/cpu
#          python -c "import torch, celux; print(f'torch: {torch.__version__}, celux: {celux.__version__}')"
#          echo "=== Import test passed ==="
#
#      - name: Upload Linux wheel
#        uses: actions/upload-artifact@v4
#        with:
#          name: linux-wheel
#          path: "dist/*.whl"
#
